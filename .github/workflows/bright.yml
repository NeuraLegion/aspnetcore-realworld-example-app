name: Security Tests

on:
  pull_request:
    branches:
      - '*'

permissions:
  checks: write
  contents: read

jobs:
  security-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.204

    - name: Install SecTester
      run: dotnet add package SecTester.Runner

    - name: Setup Docker Compose
      run: |
        echo "ASPNETCORE_Conduit_ConnectionString=${{ secrets.ASPNETCORE_Conduit_ConnectionString }}" >> $GITHUB_ENV
        echo "ASPNETCORE_Conduit_DatabaseProvider=${{ secrets.ASPNETCORE_Conduit_DatabaseProvider }}" >> $GITHUB_ENV
        docker compose up -d

    - name: Run Security Tests
      env:
        BRIGHT_HOSTNAME: ${{ vars.BRIGHT_HOSTNAME }}
        BRIGHT_PROJECT_ID: ${{ vars.BRIGHT_PROJECT_ID }}
        BRIGHT_TOKEN: ${{ secrets.BRIGHT_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        dotnet test tests/Conduit.IntegrationTests/Conduit.IntegrationTests.csproj --filter "FullyQualifiedName~Security" --logger trx --results-directory ./TestResults

    - name: Teardown Docker Compose
      if: always()
      run: docker compose down